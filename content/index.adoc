
[{invert}]
= Introduction au CI/CD
include::./attributes.adoc[]

[.title]
ENSG - Décembre 2020

[.small]
* Présentation disponible à l’adresse: {presentationUrl}[{presentationUrl}]
* Version PDF de la présentation : link:slides.pdf[+++<span class="far fa-file-pdf"></span>+++ Cliquez ici]
* This work is licensed under a Creative Commons Attribution 4.0 International License
* Code source de la présentation: link:{repositoryUrl}[+++<span class="fab fa-github"></span>+++ {repositoryUrl}]

image::qrcode.png["QRCode to this presentation",height=150]

== Comment utiliser cette présentation ?

* Pour naviguer, utilisez les flèches en bas à droite (ou celles de votre clavier)
** Gauche/Droite: changer de chapitre
** Haut/Bas: naviguer dans un chapitre
* Pour avoir une vue globale : utiliser la touche "o" (pour "*Overview*")
* Pour voir les notes de l'auteur : utilisez la touche "s" (pour "*Speaker* notes")

[{invert}]
== Bonjour !

[{invert}]
=== Damien DUPORTAL

* Freelancer
* Consultant @ link:https://www.ovh.com/fr/[OVHCloud]

* Me contacter :
** +++<span class="fa fa-envelope"></span>+++ damien.duportal+pro <chez> gmail.com
** link:https://www.linkedin.com/in/damien-duportal-ab70b524/[+++<span class="fab fa-linkedin"></span>+++ Damien Duportal,window=_blank]
** link:https://twitter.com/DamienDuportal[+++<span class="fab fa-twitter"></span>+++ @DamienDuportal,window=_blank]

[{invert}]
=== Julien LEVESY

* Señor Software Engineer @ link:https://www.upfluence.com/fr/[Upfluence]

* Me contacter :
** +++<span class="fa fa-envelope"></span>+++ jlevesy <chez> gmail.com
** link:https://www.linkedin.com/in/julien-levesy-5b80ab149/[+++<span class="fab fa-linkedin"></span>+++ Julien Levesy,window=_blank]
** link:https://twitter.com/jlevesy[+++<span class="fab fa-twitter"></span>+++ @jlevesy,window=_blank]
** link:https://github.com/jlevesy[+++<span class="fab fa-github"></span>+++ @jlevesy,window=_blank]

=== Et vous ?
[.left.text-center]
image::commitstrip.png[width="400"]

== Au Menu

1. De la feuille blanche au premier utilisateur.
2. Projet n°1: Site web de restaurant
3. Du premier utilisateur au prochain Netflix.
4. Projet n°2: Menus "as a service".

== Partie I: De la feuille blanche au premier utilisateur

Concrètement, ça veut dire quoi créer un logiciel ?

== Savoir ce que l'on veut faire!

[.notes]
--
* Créer un logiciel c'est écrire du code qui implémente une logique.
* Cette logique à pour but de répondre à un besoin.
* Il faut donc clarifier ce besoin.
--

=== Avant : le cycle en V

image::cycleenv.png[width="800"]

=== What went wrong here?

* On specifie et l'on engage un volume conséquent de travail sur des hypothèses
** ... et si les hypothèses sont fausses?
** ... et si les besoins changent?
* Cycle trèèèèès long
** Aucune validation à court terme
** Coût de l'erreur décuplé

[.notes]
--
* L'informatique manipule peu de concepts tangibles, il est très difficile de mener un travail de conception purement théorique à terme.
--

=== Comment éviter ça?

* Valider les hypothèses au plus tôt, et étendre petit à petit le périmètre fonctionel.
** Reduire le périmètre fonctionel au minimum.
** Confronter le logiciel au plus tôt aux utilisateurs.
** Refaire des hypothèses basées sur ce que l'on à appris, et recommencer!
* Accepter le changement.
** Votre première idée n'est probablement pas la bonne.
** Il est difficile, voire impossible, de prévoir comment votre logiciel va être utilisé.

[.notes]
--
* J'itère donc je suis.
* EMBRACE CHANGE
--

=== La clé : gérer le changement!

* Le changement ne doit pas être un évenement, ça doit être la norme.
* Notre objectif : minimiser le coût du changement.
* Faire en sorte que:
** Changer quelque chose soit facile
** Changer quelque chose soit rapide
** Changer quelque chose ne casse pas tout

=== Heureusement, vous avez des outils à disposition!

Et c'est ce que l'on va voir ensemble aujourd'hui!

[{invert}]
== Disclaimer: les outils c'est une chose, l'important c'est le problème derrière!

[.notes]
--
* On va vous parler de beaucoup d'outils dans ce cours, ce sont des implémentations.
* Ce qui compte, c'est les problèmes qu'ils résolvent ;-)
--

include::./chapitres/vcs.adoc[leveloffset=1]

== TODO: Version

* Parlons version en général (tag, semantic versioning?).

== Tests automatisés

Faire en sorte qu'on ne casse pas tout quand on change quelque chose...

=== Qu'est ce qu'un test ?

* C'est du code qui vérifie qu'un système fait ce qu'il est supposé faire.
* Ecrire des tests est un acte préventif et non curratif.

=== Pourquoi faire des tests ?

* Ça sert a prouver que le logiciel se comporte comme attendu a tout moment.
* Ça permet de détecter au plus tôt les problèmes.

[.notes]
--
* Cela ne permet pas de corriger des bugs, cela limite le risque d'en introduire.
--

=== Qu'est ce que l'on teste ?

* Une fonction
* Une combinaison de classes
* Un serveur applicatif et une base de données

On parle de SUT, System Under Test.

=== Différents systemes, différents types de tests

* Test unitaire
* Test d'integration
* Test de bout en bout

=== Test unitaire

* Test validant le bon comportement une unité de code (fonction, méthode...)
* Prouve que l'unité de code interagit correctement avec les autres unités.
* Par exemple:
** Retourne les bonnes valeur en fonction des paramètres donnés
** Appelle la bonne methode du bon attribut avec les bons paramètres

=== Test Unitaire: Exercices

```bash
git clone https://github.com/cicd-lectures/demoapp.git
cd demoapp
git checkout ut-exercise-1

# Run the tests
mvnw test
```

=== Test Unitaire: Exercice 1

Implementez et testez le comportement suivant:

```bash
# Si l'age de l'utilisateur est inferieur a 10, alors retourner "Hi"
# Si l'age de l'utilisateur est entre 10 et 20, alors retourner "Hey"
# Si l'age de l'utilisateur est supérieur a 20, alors retourner "Hello"
```

Chemins utiles:

```bash
# Modèle "src/main/java/com/cicdlectures/demoapp/user/User.java"
# Classe "src/main/java/com/cicdlectures/demoapp/user/GreeterService.java"
# Tests "src/test/java/com/cicdlectures/demoapp/user/GreeterServiceTests.java"
```

=== Test Unitaire: Solution Exercice 1

```bash
git checkout ut-exercise-1-solution
```

=== Test Unitaire: Exercice 2

Service de gestion d'utilisateur

=== Test Unitaire: Pro / Cons

* (+) Super rapides (<1s) et légers a executer
* (+) Pousse à avoir un bon design de code
* (+) Efficaces pour tester des cas limites
* (-) Peu réaliste

[%notitle]
=== fail

video::ut-fail-1.mp4[width="600",options="autoplay,loop,nocontrols"]

[%notitle]
=== fail2

video::ut-fail-2.mp4[width="600",options="autoplay,loop,nocontrols"]

=== Test d'Integration

* Test validant qu'un assemblage d'unités se comportent comme prévu.
* Par exemple:
** Prouve que `GET /users` retourne la liste des utilisateurs en base
** Prouve que `POST /users`  avec un nom manquant provoque une réponse HTTP 400

Prouve le bon comportement d'une partie de l'application.

=== Test d'Integration: Demonstration

=== Test d'Integration: Pro / Cons

* (+) Rapides (~1s) a executer
* (+) Relativement réalistes
* (-) Potentiellement complexes
* (-) Moins flexibles

=== Test de Bout en Bout

* Test validant qu'un cas d'utilisation est correctement implémenté par le logiciel
* Tests idéalement décrits de façon non technique
* Par exemple:
** En tant qu'un utilisateur authentifié
** Quand je remplis le formulaire correctement et appuie sur le bouton "OK"
** Alors un utilisateur est créé en base

=== Demonstration

=== Test de Bout en Bout: Pro / Cons

* (+) Au plus proche d'un cas réel
* (+) Teste tous les composants du logiciel
* (-) Lents (~1m)
* (-) Complexes
* (-) Peu flexibles

== Rendre son changement visible

=== Où votre changement est-il visible?

** Un téléphone
** Les serveurs de votre client
** Vos propres serveur
** Un microcontrolleur dans un satelite

=== Différents environements, différentes contraintes

* Comment effectuer la mise à jour?
** Est-ce que vous opérez le logiciel ?
** Est-ce qu'une mise à jour est facile ?
** Est-ce qu'une interuption de service est acceptable ?

* Plus la mise à jour sera facile, moins le risque sera élevé.

[.notes]
--
TODO: Je sais pas vraiment comment faire la transition ici.
--

=== Gérer le risque ?

* Chaque changement comporte un risque
* Il est souvent nécessaire de valider un changement avant de l'exposer au reste du monde
* Validation technique:
** Est-ce que ça marche ? Est-ce que c'est assez rapide ?
* Validation fonctionnelle:
** Est-ce que ce qui a été réalisé correspond aux attentes?

=== Différentes étapes

* Recours à des environements de tests  pour valider les changements
** Pré-versions (beta)
** Environement de pré-production, QA, staging...

* "Au plus proche" des conditions réelles...
* ...Ou la stabilité est "moins importante"

=== Processus de création logiciel

Developement -> Staging -> Production

=== Developement -> Staging

* Etapes (simplifiées)
** Tester le code: `make unit-test` && `make integration-test`
** Merger le code: `git merge` et `git push`
** Générer les artefacts: `make jar`
** Déployer les artefacts `scp ./jar.jar monutilisateur@mamachinedestaging.com:/app/binks/jar.jar`
** Redémarer mon serveur `ssh monutilisateur@mamachinedestaging.com -C "systemctl restart binks"`

=== Staging -> Production

* Etapes (simplifiées)
** Tester le code: `make unit-test` && `make integration-test`
** Merger le code: `git merge` et `git push`
** Générer les artefacts: `make jar`
** Déployer les artefacts `scp ./jar-prod.jar monutilisateur@mamachinedeprod.com:/app/rbinks/jar.jar`
** Redémarer mon serveur `ssh monutilisateur@mamachinedeprod.com -C "systemctl restart binks"`

=== What could go wrong ?

* Oublier / Inverser une étape
* Les tests ont pas été lancés depuis 3 semaines...
** ...ils sont pétés, bah c'est pas grave.
* Et si j'ai pas les droits ?
* Et si "celuiquifaitçad'habitude" est pas la aujourd'hui ?
* Et si j'ai pas un serveur mais en fait 10 ou 100 \o/

=== Une seule solution: l'automatisation !

* Rendre systématiques le plus d'opérations
** Avant chaque "git merge", on build et on joue les tests
*** Comme ça on voit tôt les problèmes!
* Automatiser les tâches redondantes
** Minimiser le risque d'erreur
** Simplifier des étapes complexes
*** Rendre le changement plus facile!

[.notes]
--
* Comme l'hygiène corporelle
** On se lave les dents, on se brosse les cheveux...
** Ce qui est important la dedans c'est de le faire régulièrement.
--

=== Comment automatiser ?

* A chaque évenement sur git effectuer une tâche
* Votre serveur git informe un autre logiciel
* Le logiciel execute un job en fonction de l'évenement notifié.

Say hello to CI/CD engines!

=== Et concrètement ?

* Quand on "push" un nouveau "commit" sur la branche "staging" alors:
** On joue les tests
** On construit un artefact
** On déploie le nouvel artefact sur le(s) serveurs de staging

=== Quelques moteurs de CI connus

- Self hosted: Jenkins, Drone CI
- SaAS: Travis CI, Semaphore CI, Circle CI, Github Actions

== Projet n°1: Menus de la cantina de Tatooine

* Votre projet c'est de délivrer un site web d'un menu pour la Cantina de Tatoine, en ces temps de covid.
* Introduction a github et au github actions ?
* Votre production: netlify, creezvousuncomptetoussa.
* yaml yaml yaml
* Votre mission si vous l'acceptez: écrire un workflow github qui met en production un siteoueb a chaque fois qu'un changement est mergé sur main.

=== Les outils a votre disposition

=== VCS

Focus sur github

=== CI Engines

Focus sur GH Actions

=== Hébergements

Netlify, server web mutu, etc.

== Partie II: Du premier utilisateur au prochain Netflix

TODO

* Travailler en équipe, kesako?

== Projet n°2

* Same idea, except that we have an API to manage now.
* Your job should run tests, build a reproductible artifact, and publish to production as soon as you hit a tag.

== Sources

* link:http//www.wikipedia.fr[Wikipedia]

[{invert}]
== Merci !

* +++<span class="fa fa-envelope"></span>+++ damien.duportal+pro <chez> gmail.com
* link:https://twitter.com/DamienDuportal[+++<span class="fab fa-twitter"></span>+++ @DamienDuportal,window=_blank]
* +++<span class="fa fa-envelope"></span>+++ jlevesy <chez> gmail.com
* link:https://twitter.com/jlevesy[+++<span class="fab fa-twitter"></span>+++ @jlevesy,window=_blank]

[.small]
link:{presentationUrl}[Slides: {presentationUrl}]

image::qrcode.png["QRCode to this presentation",height=150]

[.small]
link:{repositoryUrl}[Source on +++<span class="fab fa-github"></span>+++: {repositoryUrl}]
