[{invert}]
= Cycle de vie de votre projet

== Quel est le probl√®me ?

On a du code. C'est un bon d√©but. MAIS:

* Qu'est ce qu'on "fabrique" √† partir du code ?
* Comment faire pour "fabriquer" de la m√™me mani√®re pour tout‚Ä¢e‚Ä¢s (üíª | üñ• ) ?

== Que "fabrique" t'on √† partir du code ? üì¶

Un **livrable** :

* C'est ce que vos utilisateurs vont utiliser: un binaire √† t√©l√©charger ? L'application de production ?
* C'est versionn√©
* C'est __reproductible__

== Reproduire la fabrication üè≠

Comment fabriquer et tester de mani√®re reproductible ?

* Dimension technique: type de language, diff√©rents OS, diff√©rentes machines
* Dimension temporelle: version de d√©pendances qui changent dans le temps
* Dimension humaine: habitudes, connaissances, documentation (ou pas)

== Maven

Say Hello to "Maven":

* Id√©e de Maven : *Cycles de vie* standardis√©s
* "Convention over configuration" : fichier `pom.xml` d√©crivant le projet
* Ligne de commande `mvn` qui lit le `pom.xml` et ex√©cute les *phases*

== Maven : Cycles de vie

* 3 cycles de vie :
** üèó `default` : pour construire les applications dans `target/`
** üìù `site` : pour construire un site web de documentation dans `target/`
** üßπ `clean` : nettoyer `target/`

* Chaque cycle de vie est compos√© d'une s√©rie d'√©tapes appel√©es "phases"

== Maven : Phases

Phases du cycle de vie üèó `default` :

* `validate` - Validation du projet (syntaxe du `pom.xml` et du Java, etc.)
* `compile` - Fabrication des fichiers `.class` depuis le code java
* `test` - Ex√©cuter les tests unitaires
* `package` - Pr√©parer le livrable finale (`.jar` par exemple)
* `verify` - Ex√©cuter les tests d'int√©gration
* `install` - Mettre √† disposition le livrable localement pour d'autres projets Maven
* `deploy` - Copier le livrable dans un syst√®me de stockage de d√©pendance distant

== Maven : `pom.xml`

* "POM" signifie "Project Object Model"

* Contenu en XML : language de type "markup", avec un **sch√©ma**, donc strict

* "Convention au lieu de configuration" pour limiter la complexit√©
** code source attendu dans `src/main/java/`
** r√©sultats dans `target/` (transient), etc.
** `pom.xml` √† la racine de votre projet

== Maven : Ligne de commande `mvn`

Ligne de commande `mvn` :

* Lit le fichier `pom.xml` pour comprendre le projet
* Attend une (ou plusieurs) phases en argument
* Accepte des options (formes courtes `-X` ou longues `--debug`)
+
[source,bash]
----
# Exemples :
mvn clean # Appelle la phase "clean"
mvn compile # Appelle les phases "validate" puis "compile"
mvn clean compile -X # On peut appeler plusieurs phases et passer des options
----

== üéì Exercice Maven : C'est √† vous !

*But :* fabriquer l'application menuserver avec Maven

image::https://gitpod.io/button/open-in-gitpod.svg[link="https://gitpod.io/workspaces",window="_blank"]

Commen√ßons par valider le projet en utilisant la phase
link:https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html[`validate`] de Maven:

[source,bash]
----
mvn validate
----

[source]
----
# ...
[ERROR] The goal you specified requires a project to execute but there is no POM in this directory (/workspace/menu-server). Please verify you invoked Maven from the correct directory. -> [Help 1]
# ...
----

‚ùå Il manque un fichier `pom.xml` !

== Exercice Maven : fichier `pom.xml`

* Commen√ßons par cr√©er un fichier `pom.xml` avec le contenu ci-dessous :
+
[source,xml]
----
<!-- pom.xml -->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <!-- Insert content here  -->
</project>
----

* Puis r√©-essayons de valider le projet avec Maven :
+
[source,bash]
----
mvn validate
----
+
[source]
----
# ...
[ERROR] [ERROR] Some problems were encountered while processing the POMs:
[FATAL] 'groupId' is missing. @ line 2, column 102
[FATAL] 'artifactId' is missing. @ line 2, column 102
[FATAL] 'version' is missing. @ line 2, column 102
# ...
----

‚ùå On doit ajouter du contenu dans le `pom.xml` !

== Maven : identit√© d'un projet

Maven identifie un projet avec les 3 √©l√©ments *obligatoires* suivants :

* **groupId** : Identifiant unique de votre projet suivant les r√®gles Java de nommage de paquets
* **artifactId** : Identifiant du projet (paquet de la classe principale)
* **version** : Version de l'artefact

[source,xml]
----
<!-- pom.xml -->
<groupId>com.mycompany</groupId>
<artifactId>my-app</artifactId>
<version>1.0</version>
<!-- Exemple avec un paquet Java `com.mycompany.my-app` dans `src/main/java/com/mycompany/my-app` -->
----

== üéì Exercice Maven : identifiez votre projet

=> C'est √† vous

* Identifiez votre projet en remplissant le fichier `pom.xml`
** `groupId` et `artifactId`: utilisez le nom de package de votre classe principale `MenuServerApplication.java`
** `version` : `1.0-SNAPSHOT`

* *Objectif :* Maven doit valider le projet avec succ√®s :
+
[source,bash]
----
mvn validate
----
+
[source]
----
# ...
[INFO] BUILD SUCCESS
# ...
----

== Checkpoint üéØ

* On a pu cr√©er un fichier `pom.xml` valide ‚úÖ

* Pensez √† commiter ce changement üí°

* Il est temps de compiler l'application avec Maven üèó

== üéì Exercice Maven : Compiler üèó

* Essayez de compiler l'application √† l'aide de la phase
link:https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html[`compile`] de Maven:
+
[source,bash]
----
mvn compile
----

* R√©sultat attendu : Message `[INFO] BUILD FAILURE` ‚ùå

== Analyse des erreurs de compilation üèó

Que s'est il pass√© ?

. => Maven a t√©l√©charg√© plein de d√©pendances depuis https://repo.maven.apache.org[window="_blank"]
. => La compilation a √©chou√© avec plein d'erreurs et quelques "warning" :

[source]
----
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.10.1:compile (default-compile)
      on project my-app: Compilation failure: Compilation failure:
[ERROR] <...>/src/main/java/com/cicdlectures/menuserver/repository/MenuRepository.java:[3,43]
      package org.springframework.data.repository does not exist
----

== Maven et D√©pendances Externes

* Maven propose 2 types de d√©pendances externes :

** *Plugin* : c'est un artefact qui sera utilis√© par Maven durant son cycle de vie
*** "Build-time dependency"
** *D√©pendance* (üá¨üáß "dependency") : c'est un artefact qui sera utilis√© par votre application,
_en dehors de Maven_
*** "Run-time dependency"

== Maven et Plugins

Quand on regarde sous le capot, Maven est un framework d'ex√©cution de plugins.

=> Tout est plugin :

- Effacer le dossier `target` ? Un plugin ! (si si essayez `mvn clean` une premi√®re fois...)
- Compiler du Java ? Un plugin !
- Pas de plugin qui fait ce que vous voulez ? √âcrivez un autre plugin !

== !

*C'est bien gentil mais comment corriger notre erreur ?*

üí° Il manque des d√©pendances pour compiler :

* ‚ùå `package org.springframework.data.repository does not exist`
* ‚ùå `package jakarta.persistence does not exist`
* ‚ùå `package lombok does not exist`

== D√©pendances Externes

*Hypoth√®se* : on a besoin de code et d'outils externes (e.g. √©crits par quelqu'un d'autre)

* Comment faire si le code externe est mis √† jour ?
* Que se passe t'il si le code externe est supprim√© de l'internet ?
[.small]
** https://github.blog/2020-11-16-standing-up-for-developers-youtube-dl-is-back/[window="_blank"]
* Acceptez-vous d'ex√©cuter le code de quelqu'un d'autre sur votre machine ?
* Et si quelqu'un injecte du code malicieux dans le code externe ?
[.small]
** https://www.zdnet.com/article/malicious-npm-packages-caught-installing-remote-access-trojans/[window="_blank"]

== TOUS les languages...

// The triple plus (`+++`) are used to escape the first dot (and avoid a numbered bullet list)
+++...+++ sont concern√©s

== Maven : D√©p√¥ts d'Artefacts

Maven r√©cup√®re les d√©pendances (et plugins) dans des d√©p√¥ts d'artefacts

(üá¨üáß Artifacts Repositories) qui sont de 3 types :

* *Central* : un d√©p√¥t g√©r√© par la communaut√© - https://repo.maven.apache.org[window="_blank"]
** https://mvnrepository.com/repos/central[Avec une interface web de recherche,window="_blank]
* *Remote* : des d√©p√¥ts priv√©s de votre organisation
* *Local* : un dossier sur la machine o√π la commande `mvn` est ex√©cut√©, g√©n√©ralement dans `${HOME}/.m2`
[.small]
** üí° `mvn install` cible ce d√©p√¥t "local"

== D√©pendances Maven

üí° https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html["Introduction au m√©canisme de d√©pendances - documentation Maven]

* Pour sp√©cifier les d√©pendances (dans votre `pom.xml`):
** Il faut utiliser la balise `<dependencies>`,
** ... qui est une collection de d√©pendances (balise `<dependency>` - quelle surprise !),
** .. chaque d√©pendance √©tant d√©fini par un trio `<groupId>`, `<artifactId>` et `<version>` (que de surprises...)

* Pour les plugins c'est la m√™me id√©e (`<plugins>` -> `<plugin>` -> `<groupId>`, `<artifactId>`, `<version>`)

== Exemple de D√©pendance : Spring

* *Id√©e* : Nous avons besoin d'ajouter le framework Spring en d√©pendance.

Voil√† ce que √ßa donne dans le fichier `pom.xml` :

[source,xml,subs="+attributes"]
----
<dependencies>
  <dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
    <version>{springboot_version}</version>
  </dependency>
</dependencies>
----

== üéì Exercice avec les d√©pendances Spring 1/2

=> C'est √† vous.

* Ajoutez le bloc `<dependencies>` de la slide pr√©c√©dente dans votre `pom.xml`
** üí° https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web/{springboot_version}[org.springframework.boot.spring-boot-starter-web {springboot_version} sur Maven Central,window="_blank"]

* Ex√©cutez la commande `mvn compile`

* R√©sultat attendu :
** ‚úÖ L'erreur `package org.springframework.data.repository does not exist` a disparu: la d√©pendance est pr√©sente
** ‚ùå Encore d'autre d√©pendances manquantes (`jakarta.persistence`, `lombok`, etc.)

== üéì Exercice avec les d√©pendances Spring 2/2

* *But:* Compiler l'application compl√®te

* Continuez de modifier le fichier `pom.xml` afin d'ajouter les 2 d√©pendances suivantes :

** Lombok: https://mvnrepository.com/artifact/org.projectlombok/lombok/{lombok_version}[org.projectlombok.lombok {lombok_version} sur Maven Central,window="_blank"]
** Jakarta persistence: https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-jpa/{springboot_version}[org.springframework.boot.spring-boot-starter-data-jpa {springboot_version} sur Maven Central,window="_blank"]

* R√©sultat attendu : ‚úÖ `[INFO] BUILD SUCCESS`

== ‚úÖ Solution avec les d√©pendances Spring

[source,xml,subs="+attributes"]
----
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
    <groupId>com.cicdlectures</groupId>
    <artifactId>menuserver</artifactId>
    <version>1.0-SNAPSHOT</version>

    <dependencies>
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
        <version>{springboot_version}</version>
      </dependency>
      <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
        <version>{springboot_version}</version>
      </dependency>
      <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>{lombok_version}</version>
      </dependency>
    </dependencies>
</project>
----

== Ex√©cution de l'application Spring : Tentative 1

* Quel est le contenu de `target/` ? Et de `target/classes` ?
+
[source,bash]
----
# üí° Chercher tous les fichier dans le sous-dossier ./target/classes
find ./target/classes -type f
----

* Essayons d'ex√©cuter notre programme avec la commande `java` :
+
[source,bash]
----
java -cp target/classes/com/cicdlectures/menuserver/ \
  -cp target/classes/com/cicdlectures/menuserver/controller/ \
  -cp target/classes/com/cicdlectures/menuserver/dto/ \
  -cp target/classes/com/cicdlectures/menuserver/model/ \
  -cp target/classes/com/cicdlectures/menuserver/repository/ \
  -cp target/classes/com/cicdlectures/menuserver/service/ \
MenuServerApplication
----

== !

R√©sultat :

[source]
----
Error: Could not find or load main class MenuServerApplication
Caused by: java.lang.ClassNotFoundException: MenuServerApplication
----

image:angry-panda.gif[Loosing Patience]

== Checkpoint üéØ

* C'est la gal√®re pour trouver les bonnes d√©pendances ü§î
* `mvn compile` a produit des fichiers dans `target/classes/**` ‚úÖ
* Il faut encore pouvoir ex√©cuter l'application

=> reprenons en lisant le documentation

== Spring Boot : Read The Manual

* Spring Boot est bien plus simple √† utiliser que ce que l'on a vu üß∏ !
[.small]
** On l'a abord√© ainsi pour mieux comprendre

* Une documentation tr√®s compl√®te :
** https://spring.io/guides/gs/spring-boot/["Get Started" pour bien d√©marrer]
** https://start.spring.io/[Spring Initialzr] pour g√©n√©rer son `pom.xml` en ligne
** Une https://docs.spring.io/spring-boot/docs/2.0.x/reference/html/[documentation de r√©f√©rence]

* Un https://docs.spring.io/spring-boot/docs/2.5.6/maven-plugin/reference/htmlsingle/[plugin Maven est fourni par le projet Spring Boot]
pour se simplifier la vie:
** Pas besoin de r√©p√©ter les versions
** Plein de fonctionnalit√©s de d√©veloppement
** Moins de configuration √† faire soit m√™me

== Maven Plugins

Un plugin Maven impl√©mente les t√¢ches √† effectuer durant les diff√©rentes phases,
et peut appartenir √† l'un ou l'autre de ces 2 types :

* *"Build"* : Impl√©mente une action durant les phase du cycle de vie `default`,
et est configur√© dans la balise `<build>`
* *"Reporting"* Impl√©mente une action durant les phases du cycle de vie `site`,
et est configur√© dans la balise `<reporting>` (√† votre grande surprise)

C'est un fichier `*.jar` identifi√© par... groupId, artifactId et version.

== Plugin Maven Spring Boot

* On vous fournit le contenu du `pom.xml` (slide suivante) g√©n√©r√© (et adapt√©) depuis https://start.spring.io/[Spring Initialzr],
avec les changements suivants :

** Ajout d'un POM "parent" (dont on h√©rite) venant de Spring Boot (√âviter la r√©p√©tition)
** Configuration avec des properties (clef/valeurs)
** Mise √† jour des d√©pendances (ajouts et simplification des versions, d√©l√©gu√©es au "POM parent")
** Activation du plugin Spring Boot lors des phases de "build"

== Exemple Maven : pom.xml final

[source,xml,subs="+attributes"]
----
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.cicdlectures</groupId>
  <artifactId>menuserver</artifactId>
  <version>1.0-SNAPSHOT</version>

  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>{springboot_version}</version>
  </parent>

  <properties>
    <java.version>17</java.version>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
    </dependency>
    <dependency>
      <groupId>com.h2database</groupId>
      <artifactId>h2</artifactId>
      <scope>runtime</scope>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>
</project>
----

== üéì Exercice : D√©marrer l'application - 1/2

* *But*: Ex√©cuter l'application √† l'aide du plugin Spring Boot

* Sprint Boot fournit une phase Maven nomm√©e `spring-boot:run` qui ex√©cute
l'application en mode "d√©veloppement" sur le port `8080` local
** Essayez d'appeler cette phase avec Maven

* R√©sultat attendu (une jolie banni√®re ASCIIArt):
+
[source,subs="+attributes"]
----

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v{springboot_version})
----

== üéì Exercice : D√©marrer l'application - 2/2

* Dans un second terminal de Gitpod, affichez la page web de l'application avec les commandes suivantes :
** `gp url 8080` pour afficher l'URL publique de l'application correspondant au port `8080` local
** `gp preview "$(gp url 8080)/"` pour pr√©visualiser le "endpoint" `/` dans un navigateur local

* La page d'accueil doit afficher HTTP/404

* Trouvez la page des menus qui doit r√©pondre `[]` (liste vide en JSON)
** üí° `src/\*/controller/*.java`

== Checkpoint üéØ

* Spring Boot (et toutes ses d√©pendances) est configur√© ‚úÖ
* Le plugin Maven Spring Boot permet de compiler et d'ex√©cuter l'application avec la commande `mvn spring-boot:run` ‚úÖ
* Il faut encore fabriquer un fichier JAR üè∫ pour la production ü§î

=> reprenons avec Maven

== üéì Exercice : Maven JAR Plugin

* *But*: Produire l'artefact JAR distribuable

* La g√©n√©ration du JAR est d√©clench√©e lors de l'appel √† `mvn package` :
+
[source,bash]
----
ls -ltra ./target
mvn clean # Nettoyez tout !
ls -ltra ./target
mvn package
ls -ltra ./target # Est-ce que vous voyez un fichier JAR ?
----

* Ex√©cution de l'application :
+
[source,bash]
----
java -jar <chemin vers le fichier JAR>
----
** M√™me fonctionnement que pr√©c√©demment (banni√®re, port 8080, endpoint `/menus`...)

== üéì Exercice : Changer le nom de l'artefact final

* *But*: Produire un artefact JAR dont le nom est `menu-server.jar`

* Quel est le nom de l'artefact g√©n√©r√© ? Est-il constant ?
** (SPOILER: üôÖüèΩ‚Äç‚ôÄÔ∏è)

* En utilisant la documentation de r√©f√©rence link:https://maven.apache.org/pom.html#the-basebuild-element-set[window="_blank"],
adaptez votre `pom.xml` afin que le fichier g√©n√©r√© se nomme *toujours* `menu-server.jar`.

== ‚úÖ Solution : Changer le nom de l'artefact final

[source,xml]
----
<build>
  <finalName>menu-server</finalName>
  <!-- ... <plugins> ... -->
</build>
----

== ‚úÖ Solution: pom.xml final pour ce chapitre

[source,xml]
----
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.cicdlectures</groupId>
  <artifactId>menuserver</artifactId>
  <version>1.0-SNAPSHOT</version>

  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.0.2</version>
  </parent>

  <properties>
    <java.version>17</java.version>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
    </dependency>
    <dependency>
      <groupId>com.h2database</groupId>
      <artifactId>h2</artifactId>
      <scope>runtime</scope>
    </dependency>
  </dependencies>

  <build>
    <finalName>menu-server</finalName>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>
</project>
----

== Checkpoint üéØ

* Le projet Menu Server est configur√© avec Maven (`pom.xml`) ‚úÖ
* On peut v√©rifier l'application localement avec la commande `mvn spring-boot:run` ‚úÖ
* L'application est fabriqu√©e avec la commande `mvn package` qui produit le d√©livrable `./target/menu-server.jar` ‚úÖ
