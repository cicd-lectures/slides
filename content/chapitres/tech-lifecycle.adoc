
[{invert}]
= Cycle de vie technique

== Quel est le probl√®me ?

On a du code (qu'on sait changer et tester).

* Qu'est ce qu'on "fabrique" √† partir du code ?
* Comment faire pour "fabriquer" de la m√™me mani√®re pour tout‚Ä¢e‚Ä¢s (üíª | üñ• ) ?

== Que "fabrique" t'on √† partir du code ?

Un **livrable** :

* C'est ce qu'on utilise dans la "vraie vie"
* C'est versionn√©
* C'est __reproductible__

== Reproduire la fabrication

Comment fabriquer et tester de mani√®re reproductible ?

* Linux / Windows / Mac
* Puissance disponible
* Habitudes diff√©rentes

=> üõ† Il faut des outils pour g√©rer le cycle de vie technique (Build -> Test -> etc.)

[{invert}]
== Exemple avec Make

Fabriquons (joyeusement) des pages en HTML

== Exemple Make : Livrable

D√©finissons le livrable :

* Un dossier nomm√© `dist`...
* ...avec un fichier `index.html` dedans

[source,bash]
----
$ ls ./dist/
index.html
----

== Exemple Make : Code source

* On utilise le format link:https://asciidoctor.org/[Asciidoctor] pour √©crire le **contenu**
** Format de fichier `.adoc`
** Exemple de syntaxe Asciidoctor :

[source,asciidoctor]
----
include::../code-samples/tech-lifecycle/main.adoc[]
----

== Exemple Make : Asciidoctor -> HTML

=> C'est √† vous (dans link:https://gitpod.io#https://github.com/cicd-lectures/demoapp[l'environnement GitPod,window=_blank])

* Cr√©ez un nouveau projet nomm√© `exercice-makefile`
+
[source,bash]
mkdir -p /workspace/exercice-makefile && cd /workspace/exercice-makefile

* Ajoutez un nouveau fichier `main.adoc` comme celui de la slide pr√©c√©dente

* G√©n√©rez un fichier HTML avec la commande `asciidoctor` :
+
[source,bash]
----
$ asciidoctor main.adoc
$ ls -ltr
# ...
main.html
# ...
----

* Affichez le fichier HTML en aper√ßu

image::gitpod-open-side-preview.png[width=200]

== Exemple Make : R√©cap√©p√®te

image::make-flow-1.svg[width=800]

== Exemple Make : Introduction √† Makefile

* link:https://www.gnu.org/software/make/[GNU Make] est une ligne de commande,
* qui lit un fichier `Makefile` pour ex√©cuter des t√¢ches.
* Chaque t√¢che (ou "r√®gle") est d√©crite par une "cible":
* Format d'une "cible" make :
+
[source,makefile]
----
cible: dependance
	commandes
----
* On appelle la commande `make` avec une ou plusieurs cibles en argument :
+
[source,bash]
----
make clean build
----

== Exemple de Makefile

[source,makefile]
----
# Fabrique le fichier "hello" (binaire) √† partir des fichier "hello.o" et "main.o"
hello: hello.o main.o
	gcc -o hello hello.o main.o

# Fabrique le fichier "hello.o" √† partir du code source "hello.c"
hello.o: hello.c
	gcc -o hello.o -c hello.c

# Fabrique le fichier "main.o" √† partir du code source "main.c"
main.o: main.c
	gcc -o main.o -c main.c
----

[source,bash]
----
make hello # Appelle implicitement "make hello.o" et "make main.o"
## √©quivalent √† "make hello.o main.o hello"
----

== Exemple Make : Makefile - Build

* *But :* on veut g√©n√©rer le HTML en appelant la commande `make main.html`
* Toujours dans link:https://gitpod.io#https://github.com/cicd-lectures/demoapp[l'environnement GitPod,window=_blank],
supprimez le fichier `main.html` si vous l'avez d√©j√†
* Cr√©ez un fichier `Makefile` qui contient une cible `main.html` et qui appelle la commande `asciidoctor`:
+
[source,Makefile]
----
include::../code-samples/tech-lifecycle/Makefile[tags="build"]
----

* Essayez avec la commande `make main.html`

== Exemple Make : Makefile Avanc√©

* Par d√©faut une cible/r√®gle correspond √† un fichier
** Si le fichier existe, `make` ne r√©-ex√©cutera pas les commandes

* Pour d√©sactiver ce comportement pour une cible donn√©e,
ajoutez ladite cible comme d√©pendance √† la cible sp√©ciale `.PHONY`
** On peut r√©p√©ter `.PHONY` plusieurs fois

* Si vous appellez `make` sans argument,
alors la cible par d√©faut sera la premi√®re cible d√©finie

== Exercice Make : Makefile - Clean

* *But :* on veut supprimer les fichiers qu'on a g√©n√©r√© lorsqu'on appelle la commande `make clean`
* Cette commande doit **toujours** s'ex√©cuter, m√™me si un fichier `clean` existe

=> C'est √† vous !

== Solution : Makefile - Clean

[source,Makefile]
----
include::../code-samples/tech-lifecycle/Makefile[tags="build,clean-v1"]
----

[source,bash]
----
touch clean # Cr√©ez un fichier "clean" bidon
make main.html
ls -l # 1 fichier "main.html"
make clean
ls -l # Aucun fichier "main.html"
rm -f clean # Nettoyage
----

== Exercice Make : Makefile - Livrable

* *But :* on veut g√©n√©rer le livrable en appelant la commande `make dist`
* On utilisera les commandes `mkdir` et `cp` pour cette cible
* ‚ö†Ô∏è Il y a une **d√©pendance** sur la cible `main.html`
* ‚ö†Ô∏è Il faudra sans doute adapter `clean` et `.PHONY`

=> C'est √† vous !

== Solution : Makefile - Livrable

[source,Makefile]
----
include::../code-samples/tech-lifecycle/Makefile[tags="build,dist,clean-v2"]
----

[source,bash]
----
make clean
ls -l # Aucun fichier "main.html" ni "dist/index.html"
make dist
ls -l # 2 fichiers "main.html et "dist/index.html"
----

== Exercice Make : Makefile - All

* *But :* on veut que Make cr√©√©/re-cr√©√© le livrable **de z√©ro** par d√©faut lorsqu'on appelle `make` sans argument
* Cette cible doit s'appeller `all` et va appellez `clean` (au moins)

=> C'est √† vous !

== Solution : Makefile - All

[source,Makefile]
----
include::../code-samples/tech-lifecycle/Makefile[tags="all,!clean-v1"]
----

[source,bash]
----
make clean
ls -l # Aucun fichier "index.html" ou "example-make.tar.gz"
make
ls -l # 2 nouveaux fichiers "index.html ou "example-make.tar.gz"
make clean
ls -l # Aucun fichier "index.html" ou "example-make.tar.gz"
----

// == Exemple Make : Tests ?

// Diagramme :

// `main.adoc` -(build)-> `index.html` -(TEST?)-> -(package)-> `example-make.tar.gz`

// [%step]
// * Lien HTTP en 404 dans le HTML ?
// * Valide W3C ?

// == Exercice : Tester du HTML

// * Commande pour tester le HTML:
// // W3C ou lien mort ou les deux ?
// * But : ajouter une cible Makefile pour tester avant de packager
// * V√©rification:
// ** Ecrivez un lien HTTP invalide dans `main.adoc`
// ** Vous ne pouvez pas "packager" (commande doite √™tre en erreur) avec `make all`

// == Solution : Tester du HTML

[{invert}]
== Exemple avec Maven

JAVA bien ?

== Exemple Maven : Livrable

* Fichier "JAR" (Java ARchive)
** C'est une archive "ZIP" pour distribuer des applications en java
** Pour ex√©cuter le programme depuis le livrable :
+
[source,bash]
----
java -jar <fichier.jar>
----

== Exemple Maven : Code source

* Code Source attendu dans `src/*/<language>/**`
** Code Java de l'application dans `src/main/java/**`
** Code (Java) des tests dans `src/test/java/**`

== Exemple Make : Java -> JAR

* La commande `javac` permet de "compiler" du java en bytecode java:
+
[source,bash]
----
$ javac ./src/main/java/com/cicdlectures/demoapp/Application.java --directory=./Application.class
./src/main/java/com/cicdlectures/demoapp/Application.java:4: error: package org.springframework.boot.autoconfigure does not exist
----

* Comment g√©rer les dependances ?
* Comment assembler les `.class` pour faire un `.jar`?
* Et les tests ?

=> C'est vite **complexe** alors qu'on veut √©crire un programme

== Exemple Maven : Introduction √† Maven

Say Hello to "Maven":

* Id√©e de Maven : *Cycle de vie* standardis√© compos√© de "phases"
* Configuration Maven : `pom.xml` (Project Object Model)
* Ligne de commande `mvn` qui ex√©cute les *phases*
** Enchainement de *phases* s√©quentiellement

‚ö†Ô∏è D'autres alternatives existent : Gradle, Bazel, etc.

== Exemple Maven : Commande `mvn`

Ligne de commande `mvn` :

* Lit le fichier `./pom.xml` pour comprendre le projet
* Ex√©cute les phases ("√©tapes") pass√©es en argument,
ainsi que leurs d√©pendances :
+
[source,bash]
----
mvn clean # Appelle la phase "clean"
mvn compile # Appelle les phases "validate" puis "compile"
mvn clean compile -X # On peut appeller plusieurs phases et passer des options
----
* Le r√©sultat est dans `./target`

== Exemple Maven : Les phases de Maven

* `clean` - Nettoie le contenu du dossier `./target`
* `validate` - Validation du projet (syntaxe du `pom.xml` et du Java, etc.)
* `compile` - Fabrication des fichiers `.class` depuis le code java
* `test` - Ex√©cuter les tests unitaires
* `package` - Pr√©parer le livrable finale (`.jar` par exemple)
* `verify` - Ex√©cuter les tests d'int√©gration
* `install` - Mettre √† disposition le livrable localement pour d'autres projets Maven
* `deploy` - Copier le livrable dans un syst√®me de stockage de d√©pendance distant

== Exemple Maven : C'est √† vous !


=> C'est √† vous (dans link:https://gitpod.io#https://github.com/cicd-lectures/demoapp[l'environnement GitPod,window=_blank])

* Cr√©ez un nouveau projet nomm√© `exercice-maven`
+
[source,bash]
mkdir -p /workspace/exercice-maven && cd /workspace/exercice-maven

* On va nettoyer ce qu'on a d√©j√† produit:
+
[source,bash]
----
mvn clean # Supprime le contenu du dossier `./target
ls -l ./target
----
* ‚ö†Ô∏è La phase `clean` est sp√©ciale et n'est jamais appell√©e par les autres phases

== Exemple Maven : Compiler

* But: Compilez le code source et visualisez le contenu du dossier `target` :
+
[source,bash]
----
ls -l ./target # Avant
mvn compile
ls -l ./target # Apr√®s
----

[.notes]
--
* R√©solution des d√©pendances
* Pr√©-traitement du code source
* Compilation des classes
--

== Exemple Maven : Tests Unitaires

* But: Compilez le code source et visualisez le contenu du dossier `target` :
+
[source,bash]
----
ls -l ./target # Avant
mvn test
ls -l ./target # Apr√®s
ls -l ./target/surefire-reports
----

[.notes]
--
* Ex√©cute le goal `compile`
* Compilation des tests unitaires
* Ex√©cution des tests unitaires
* Rapports de tests dans *`./target/surefire-reports`*
--

== Exemple Maven : Fabriquer le livrable

* But: G√©n√©rez le livrable au format `.jar` :
+
[source,bash]
----
ls -l ./target # Avant
mvn package
ls -l ./target # Apr√®s
----

[.notes]
--
* Ex√©cute les goals `compile` et `test`
* Paquetage de l'application
--

== Exercice Maven : Tests d'int√©gration

* But: Ex√©cuter les tests d'int√©grations et afficher les rapport de tests
** ‚ö†Ô∏è Pi√®ge : regardez bien le contenu du dossier `./target`

== Solution : Tests d'int√©gration

[source,bash]
----
ls -l ./target # Avant
mvn verify
ls -l ./target/failsafe-reports
----

[.notes]
--
* Ex√©cute `compile`, `test` et `package`
* Compile et ex√©cute les tests d'int√©gration
sur l'application empaquet√©e
* Rapport de tests dans *`./target/failsafe-reports`*
--

// == Exemple Maven : Ex√©cution du livrable

// * Spring Boot demo ex√©cut√©e comme un *"√úber-Jar"*
// * Ex√©cution avec la commande java:
// +
// [source,subs="attributes",bash]
// ----
// java -jar ./target/demoapp.jar
// # Utiliser CTRL-C pour arr√™ter
// ----
// * Ouvrir une autre instance de *DevBox* (link:{devbox-url}[Click Me, window=_blank]) et v√©rifier
// link:http//localhost:8080[] avec `curl`
// +
// [source,subs="attributes",bash]
// ----
// curl -v http://localhost:8080/
// ----
