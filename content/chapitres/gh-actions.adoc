
[{invert}]
= Github Actions

== Github Actions

Github Actions est un moteur de CI/CD int√©gr√© √† Github

* ‚úÖ : Tr√®s facile √† mettre en place, gratuit et int√©gr√© compl√®tement
* ‚ùå : Utilisable uniquement avec Github, et DANS la plateforme Github

== Concepts de Github Actions

image::gh-actions-concepts.svg[width=800]

== Concepts de Github Actions - Step

Une *Step* (√©tape) est une t√¢che individuelle √† faire effectuer par le CI :

* Par d√©faut c'est une commande √† ex√©cuter - mot clef `run`
* Ou une "action" (quel est le nom du produit d√©j√† ?) - mot clef `uses`
** R√©utilisables et https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/finding-and-customizing-actions[partageables]

== Concepts de Github Actions - Job

Un *Job* est un groupe logique de t√¢ches :

* Enchainement _s√©quentiel_ de t√¢ches
* Regroupement logique : "qui a un sens" (exemple : )

== Concepts de Github Actions - Runner

Un *Runner* est un serveur distant sur lequel s'ex√©cute un job.

* Mot clef `runs-on` dans la d√©finition d'un job
* D√©faut : machine virtuelle Ubuntu dans le cloud utilis√© par Github
* https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners[D'autres types sont disponibles]
(macOS, Windows, etc.)
* Possibilit√© de fournir https://docs.github.com/en/free-pro-team@latest/actions/reference/specifications-for-github-hosted-runners[son propre serveur]

== Concepts de Github Actions - Workflow

Un *Workflow* est une proc√©dure automatis√©e compos√©e de plusieurs jobs,
d√©crite par un fichier YAML.

* On parle de "Workflow/Pipeline as Code"
* Chemin : `.github/workflows/<nom du workflow>.yml`
* On peut avoir _plusieurs_ fichiers donc _plusieurs_ workflows

== Concepts de Github Actions - Ev√®nement

Un *√©v√®nement* du projet Github (push, merge, nouvelle issue, etc. ) d√©clenche l'ex√©cution du workflow

* Plein de type d'√©v√®nements : push, issue, alarme r√©guli√®re, favori, fork, etc.
* Le workflow est ex√©cut√© pour un commit donn√© (Rappel : "Workflow as Code")

== Concepts de Github Actions : Exemple

.Workflow File :
[source,yaml]
----
name: Node.js CI
on: [push]
jobs:
  test-linux:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
    - run: npm install
    - run: npm test

  test-mac:
    runs-on: mac-10.15
    steps:
    - uses: actions/checkout@v2
    - run: npm install
    - run: npm test
----

== Concepts de Github Actions - R√©cap√©p√®te

image::gh-actions-concepts.svg[width=800]

== Essayons Github Actions

* *But* : nous allons cr√©er notre premier workflow dans Github Actions

* N'h√©sitez pas √† utiliser la documentation de GitHub Actions:
** https://docs.github.com/en/free-pro-team@latest/actions[Accueil]
** https://docs.github.com/en/free-pro-team@latest/actions/quickstart[Quickstart]
** https://docs.github.com/en/free-pro-team@latest/actions/reference[R√©f√©rence]

* Retournez dans le d√©p√¥t cr√©√© pr√©c√©demment dans votre environnement gitpod

== Exemple simple avec Github Actions

* Cr√©ez le fichier `.github/workflows/bonjour.yml` avec le contenu suivant :

[source,yaml]
----
name: Bonjour
on: [push]
jobs:
  dire_bonjour:
    runs-on: ubuntu-20.04
    steps:
    - run: echo "Bonjour üëã "
----

* Revenez sur la page GitHub de votre projet et naviguez dans l'onglet "Actions" :
** Voyez-vous un workflow ? Et un Job ? Et le message affich√© par la commande `echo` ?

== Exemple simple avec Github Actions : R√©cap√©p√®te

image::gh-actions-simple-example.svg[width=800]

== Exemple Github Actions : Checkout

* Supposons que l'on souhaite utiliser le code du d√©p√¥t...
** Essayez: modifiez le fichier `bonjour.yml` pour afficher le contenu de `README.md` :
+
[source,yaml]
----
name: Bonjour
on: [push]
jobs:
  dire_bonjour:
    runs-on: ubuntu-20.04
    steps:
    - run: ls -l # Liste les fichier du r√©pertoire courant
    - run: cat README.md # Affiche le contenu du fichier `README.md` √† la base du d√©p√¥t
----

* Est-ce que l'√©tape `cat README.md` se passe bien ? (SPOILER: non ‚ùå )

== Exercice Github Actions : Checkout

* *But* : On souhaite r√©cup√©rer ("checkout") le code du d√©p√¥t dans le job

* C'est √† vous d'essayer de _r√©parer_ le job :
** L'√©tape `cat README.md` doit √™tre conserv√©e et doit fonctionner
** Utilisez l'action "checkout" (https://github.com/marketplace/actions/checkout[Documentation]) du marketplace GitHub Action
** Vous pouvez vous inspirer du https://docs.github.com/en/free-pro-team@latest/actions/quickstart[Quickstart] de GitHub Actions

== Solution Github Actions : Checkout

[source,yaml]
----
name: Bonjour
on: [push]
jobs:
  dire_bonjour:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2 # R√©cup√®re le contenu du d√©p√¥t correspondant au commit du workflow en cours
    - run: cat README.md # Affiche le contenu du fichier `README.md` √† la base du d√©p√¥t
----

== Exemple : Environnement d'ex√©cution

* Notre pipeline de build dit que "la vache" doit afficher le contenu du fichier `README.md`
** WAT (Non, nous ne sommes pas fous) ?

[%steps]
* Essayez la commande `cat README.md | cowsay` dans GitPod
** Essayez de mettre √† jour le workflow pour faire la m√™me chose dans GitHub Actions
** SPOILER: ‚ùå (la commande `cowsay` n'est pas disponible dans le runner GitHub Actions)

== Exercice : Environnement d'ex√©cution

* *But* : On souhaite utiliser une commande sp√©cifique durant notre job

* Deux types de solutions existent, chacune avec ses inconv√©nients :
** Installer les outils manquants en pr√©ambule de chaque job (‚ùå lent ‚úÖ facile )
** Utiliser Docker pour fabriquer une action Github (‚ùå complexe ‚úÖ portable)

* C'est √† vous :
** Cherchez comment installer `cowsay` dans Ubuntu 20.04
** Appliquer cette solution dans votre job afin de le "r√©parer" et de voir la vache dans GitHub Actions.

== Solution : Environnement d'ex√©cution

[source,yaml]
----
name: Bonjour
on: [push]
jobs:
  dire_bonjour:
    runs-on: ubuntu-20.04
    steps:
    - run: sudo apt-get update && sudo apt-get install -y cowsay
    - uses: actions/checkout@v2
    - run: cat README.md | cowsay
----
