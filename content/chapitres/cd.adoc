[{invert}]
= "Continuous Everything"

== Livraison Continue

Continuous Delivery (CD)

== ü§î Pourquoi la Livraison Continue ?

* Diminuer les risque li√©s au d√©ploiement
* Permettre de r√©colter des retours utilisateurs plus souvent
* Rendre l'avancement visible par *tous*

[quote, Mary and Tom Poppendieck]
____
How long would it take to your organization to deploy a change that
involves just one single line of code?
____

== Qu'est ce que la Livraison Continue ?

* Suite logique de l'int√©gration continue:
** Chaque changement est *potentiellement* d√©ployable en production
** Le d√©ploiement peut donc √™tre effectu√© √† *tout* moment

[quote, Martin Fowler]
____
Your team prioritizes keeping the software *deployable* over working on new features
____

[{invert}]
== !

La livraison continue est l'exercice de **mettre √† disposition automatiquement** le produit logiciel pour qu'il soit pr√™t √† √™tre d√©ploy√© √† tout moment.

== Livraison Continue avec GitHub

Hello Github Releases!

== Anatomie d'une Release GitHub

Une release GiHub est associ√©e √† un tag git et porte :

* Un titre
* Un descriptif des changements
* Une collection de d'assets dont:
** Des tarballs du code source a cette version (automatique)
** Et √©ventuellement des fichiers de votre choix (des binaires compil√©s par exemple)

image::menu-server-releases.png[]

== Pr√©requis: ex√©cution conditionnelle des jobs

Il est possible d‚Äôex√©cuter conditionnellement un job ou un step √† l'aide du mot cl√© `if` (link:https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idif[documentation de `if`,window="_blank"]])

[source,yaml]
----
jobs:
  release:
    # Lance le job release uniquement si la branche est main.
    if: contains('refs/heads/main', github.ref)
    steps:
      # ...
----

== üéì Exercice: Cr√©er une Release depuis le CI

Changez votre workflow de CI de fa√ßon √† ce que sur un push de tag, le CI effectue les t√¢ches suivantes dans un nouveau job:

* Une fois que l'√©tape `build` est termin√©e
* T√©l√©charge et d√©compresse l'artefact g√©n√©r√© par le job `build`
* Cr√©er une nouvelle release dans votre d√©p√¥t ayant pour titre le nom du tag
* Upload `jar` de l'application dans cette release nouvellement cr√©√©e

On vous sugg√®re d'utiliser la CLI `gh` fournie par GitHub:

* link:https://cli.github.com/manual/gh_release_create[Documentation de `gh release create`,window="_blank"]
* Astuce: pensez a bien utiliser l'option `--generate-notes`

== D√©ploiement Continu

Continuous Deployment

== ü§î Qu'est ce que le D√©ploiement Continu ?

* Version "avanc√©e" de la livraison continue:
** Chaque changement *est* d√©ploy√© en production, de mani√®re *automatique*

== Continuous Delivery versus Deployment

image::continuous-depl-vs-delivery.jpg[caption=Continuous Delivery vs Deployment,width=700]

[.small]
Source : http://blog.crisp.se/2013/02/05/yassalsundman/continuous-delivery-vs-continuous-deployment

== B√©n√©fices du D√©ploiement Continu

* Rends triviale les proc√©dures de mise en production et de rollback
** Encourage √† mettre en production le plus souvent possible
** Encourage √† faire des mises en production incr√©mentales
* Limite les risques d'erreur lors de la mise en production
* Fonctionne de 1 √† 1000 serveurs et plus encore...

== Qu'est ce que "La production" ?

* Un (ou plusieurs) ordinateur ou votre / vos applications sont ex√©cut√©es
* Ce sont l√† o√π vos utilisateurs "utilisent" votre code
** Que ce soit un serveur web pour une application web
** Ou un t√©l√©phone pour une application mobile
* Certaines plateformes sont plus ou moins outill√©es pour la mise en production automatique

== Introduction √† Google Cloud Run

* Dans le cadre de ce cours nous allons utiliser link:https://cloud.google.com/run[Google Cloud  Run,window="_blank"]
** Un Produit de Google Cloud Platform (GCP)
* Cloud Run Permets d'ex√©cuter des images de containers (üê≥ wink wink) et de les exposer sur internet sans avoir a se soucier de l'infrastructure en dessous.
* Ideal dans le cadre de notre projet!
* Environment sponsorise par https://www.voi.com/[Voi,window="_blank"] pour le cours.

== Construire une Image de Container pour Cloud Run

* A la racine de votre d√©p√¥t menu-server cr√©ez un fichier `Dockerfile` avec le contenu suivant :

[source,Dockerfile]
----
# Depuis l'image de base azul/zulu-openjdk:11 (qui embarque un JRE dans la version 11)
FROM azul/zulu-openjdk:17

# Copier l'archive JAR depuis l'h√¥te dans le fichier /opt/app/menu-server.jar de l'image
COPY target/menu-server.jar /opt/app/menu-server.jar

# D√©finis la commande par d√©faut du container √† java -jar /opt/app/menu-server.jar  --server.port=${PORT}
# La variable d'environnement PORT est d√©finie par Google Cloud Run √† la cr√©ation du container.
CMD ["java","-jar","/opt/app/menu-server.jar", "--server.port=${PORT}"]
----

== üéì Exercice: cr√©ez et ex√©cutez l'image dans votre Workspace

* Dans un terminal, lancez les commandes suivantes:

[source,bash]
----
# On repackage l'app
mvn package

IMAGE_NAME="cicdlectures/menu-server:test"

# Construit une image docker portant le tag `cicdlectures/menu-server:test`
docker image build --tag="${IMAGE_NAME}" ./

# Lance un container bas√© sur l'image `cicdlectures/menu-server:test` sans specifier la variable d'environnement PORT
docker container run --tty --interactive --rm --publish 8080:9090 "${IMAGE_NAME}"
# Badaboum attendu!

# Lance un container bas√© sur l'image `cicdlectures/menu-server:test`
docker container run --tty --interactive --rm --env PORT=9090 --publish 8080:9090 "${IMAGE_NAME}"

# V√©rifiez que vous pouvez faire des requ√™tes au menu-server....
# Et Ctrl+C pour terminer l'ex√©cution du container
----

== D√©ployer dans Cloud Run

Les grandes √©tapes d'un d√©ploiement dans Cloud Run

1. On construit une image de container de l'application et la publie dans une registry d'images Google Cloud.
2. On demande ensuite a Cloud Run d'instancier un nouveau container utilisant la nouvelle image publi√©e.

== üéì Exercice: Connectez vous a Google Cloud depuis votre Workspace

Cela n√©cessite un compte Google, si vous n'en avez pas vous pouvez en cr√©er un link:https://accounts.google.com/signup[ici,window="_blank"].

[source,bash]
----
# Authentifie votre instance gitpod aupr√®s de google cloud
gcloud auth login

# Param√©trise le projet
GCP_PROJECT_NAME=voi-sdbx-ensg-2023
GCP_REGISTRY=europe-west9-docker.pkg.dev

# Indique a la CLI google cloud d'utiliser le projet partage pour le cours.
gcloud config set project "${GCP_PROJECT_NAME}"

# Authentifie le d√©mon docker de votre instance aupr√®s de la registry Google Cloud.
gcloud auth configure-docker "${GCP_REGISTRY}"
----

== üéì Exercice: D√©ployez votre Menu Server dans Cloud Run

[source,bash]
----
GCP_IMAGE_NAME="${GCP_REGISTRY}/${GCP_PROJECT_NAME}/cicd-registry/<votre-bin√¥me>/menu-server:test-cloudrun"

# On renomme l'image avec le nom de la registry
docker image tag "${IMAGE_NAME}" "${GCP_IMAGE_NAME}"

# On publie l'image dans la registry google cloud
docker image push "${GCP_IMAGE_NAME}"

# On d√©ploie l'image publi√©e dans cloud run
gcloud run deploy <votre-d√©p√¥t> --image="${GCP_IMAGE_NAME}" --region=europe-west9
----

[{invert}]
== !

Mais le faire manuellement c'est pas du d√©ploiement continu! Il faut le faire depuis GitHub action!

== üéì Exercice: Mise en Place du D√©ploiement Continu dans Cloud Run depuis votre Workflow

Changez votre workflow de CI pour que, sur un √©v√®nement de push de tag de version:

* Une fois le build termin√© un nouveau job `release-cloud-run` soit lanc√©
* Ce job effectue dans l'ordre:
** T√©l√©charge l'artefact de l'√©tape `build`
** Checkout le depot (pour rapatrier le Dockerfile)
** Appelle l'action link:https://github.com/cicd-lectures/cloudrun-release[Cloud Run Release,window="_blank"] pour deployer automatiquement une nouvelle version de votre application.
