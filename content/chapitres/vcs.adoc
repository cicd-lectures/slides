
[{invert}]
= Changer du code

== Tracer le changement dans le code

avec un *VCS* : üá¨üáß Version Control System

[.small]
√©galement connu sous le nom de SCM (üá¨üáß Source Code Management)

== Pourquoi un VCS ?

* Pour conserver une trace de *tous* les changements dans un historique

* Pour *collaborer* efficacement sur un m√™me r√©f√©rentiel de code source

[.notes]
--
* Historique : On parle de source unique de v√©rit√© (_Single Source of Truth_)
** Historique complet des modifications
** Possibilit√© de retour arri√®re √† tout moment

* Collaboration:
** Aide √† la r√©solution de conflits
** Partage de contenu facile
--

== Concepts des VCS

image::scm-local.png[caption="Local SCM",width=300]

image::scm-distributed.png[caption="Centralized SCM",width=300]

[.small]
Source : https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control

[.notes]
--
* Une base de donn√©e locale contenant l'historique de tous les changements
* Un espace de travail qui contient des fichiers
** C'est une "photographie" d'une des versions
--

== Quel VCS utiliser ?

image::cloudwords-vcs.png[width=500]

Nous allons utiliser *Git*

== Git

[quote]
____
Git is a free and open source distributed version control system designed to handle everything from small to very large projects with speed and efficiency.
____

link:https://git-scm.com/[]

image::git-logo.png[]

== Les 3 √©tats avec Git

* L'historique ("Version Database") : dossier `.git`
* Dossier de votre projet ("Working Directory") - Commande
* La zone d'index ("Staging Area")

image::git-3-etats.png[width=300]

[.small]
Source : https://git-scm.com/book/fr/v2/D%C3%A9marrage-rapide-Rudiments-de-Git#_les_trois_%C3%A9tats

== Exercice avec Git - 1.1

* Acc√©dez √† link:https://gitpod.io#https://github.com/cicd-lectures/demoapp[l'environnement de travail,window="_blank"]
* Rendez vous dans le r√©pertoire `/workspace` (`cd /workspace`)

* Cr√©ez un dossier vide nomm√© `projet-vcs-1` (`mkdir -p ./projet-vcs-1/`)
** Est-ce qu'il y a un dossier `.git/` ?
** Essayez la commande `git status` ?

* Initialisez le d√©p√¥t git avec `git init`
** Est-ce qu'il y a un dossier `.git/` ?
** Essayez la commande `git status` ?

== Solution de l'exercice avec Git - 1.1

[source,bash]
--
cd /workspace
mkdir -p ./projet-vcs-1/
cd ./projet-vcs-1/
ls -la # Pas de dossier .git
git status # Erreur "fatal: not a git repository"
git init ./
ls -la # On a un dossier .git
git status # Succ√®s avec un message "On branch master No commits yet"
--

== Exercice avec Git - 1.2

* Cr√©ez un fichier `README.md` dedans avec un titre et vos nom et pr√©noms
** Essayez la commande `git status` ?

* Ajoutez le fichier √† la zone d'indexation √† l'aide de la commande `git add (...)`
** Essayez la commande `git status` ?

* Cr√©ez un commit qui ajoute le fichier `README.md` avec un message,
√† l'aide de la commande `git commit -m <message>`
** Essayez la commande `git status` ?

== Solution de l'exercice avec Git - 1.2

[source,bash]
--
echo "# Read Me\n\nObi Wan" > ./README.md
git status # Message "Untracked file"
git add ./README.md
git status # Message "Changes to be committed"
git commit -m "Ajout du README au projet"
git status  # Message "nothing to commit, working tree clean"
--

== Terminologie de Git - Diff et changeset

*diff:* un ensemble de lignes "chang√©es" sur un fichier donn√©

image::diff.png[width=600]

*changeset:* un ensemble de "diff" (donc peut couvrir plusieurs fichiers)

image::changeset.png[height=200]

== Terminologie de Git - Commit

*commit:* un changeset qui poss√®de un (commit) parent, associ√© √† un message

image::commit.png[height=150]

_"HEAD"_: C'est le dernier commit dans l'historique

image::scm-basics-legend.png[]

image::scm-basics-history.png[]

== Exercice avec Git - 2

* Afficher la liste des commits

* Afficher le changeset associ√© √† un commit

* Modifier du contenu dans `README.md` et afficher le diff

* Annulez ce changement sur `README.md`

== Solution de l'exercice avec Git - 2

[source,bash]
--
git log
git show # Show the "HEAD" commit
echo "# Read Me\n\nObi Wan Kenobi" > ./README.md
git diff
git status
git checkout -- README.md
git status
--

== Terminologie de Git - Branche

* Abstraction d'une version "isol√©e" du code
* Concr√®tement, une *branche* est un alias pointant vers un "commit"

image::scm-branches.png[caption="SCM branches"]

== Exercice avec Git - 3

* Cr√©er une branche nomm√©e `feature/html`

* Ajouter un nouveau commit contenant un nouveau fichier `index.html` sur cette branche

* Afficher le graphe correspondant √† cette branche avec `git log --graph`

== Solution de l'exercice avec Git - 3

[source,bash]
--
git branch feature/html && git checkout feature/html
# Ou git checkout -b feature/html
echo '<h1>Hello</h1>' > ./index.html
git add ./index.html && git commit -m "Ajout d'une page HTML par d√©faut"
git log --graph
# git log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit
--

== Terminologie de Git - Merge

* On int√®gre une branche dans une autre en effectuant un *merge*
** Un nouveau commit est cr√©√©, fruit de la combinaison de 2 autres commits

image::scm-merge.png[caption="SCM Merge"]

== Exercice avec Git - 4

* Merger la branche `feature/html` dans la branche principale

* Afficher le graphe correspondant √† cette branche avec `git log --graph`

== Solution de l'exercice avec Git - 4

[source,bash]
--
git checkout master
git merge feature/html
git log --graph
# git log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit
--

== Feature Branch Flow

* *Une seule* branche *par* fonctionnalit√©

image::scm-feature-branch-workflow.png[caption="Feature Branch SCM Workflow",link=https://twitter.com/jay_gee/status/702638177471873024]

[NOTE.speaker]
====
** Encapsulation allows working without disturbing the main codebase
** Allows easier collaboration
** Merge conflicts map the conceptual conflicts: easier to track
** Useful when inclusion of a feature in the main code base is open to debate
====

== Exemple d'usages de VCS

* "Infrastructure as Code" :
** Besoins de tra√ßabilit√©, de d√©finition explicite et de gestion de conflits
** Collaboration requise pour chaque changement (revue, responsabilit√©s)
* Code Civil:
** https://github.com/steeve/france.code-civil
** https://github.com/steeve/france.code-civil/pull/40

== Pour aller plus loin avec Git et les VCS...

Un peu de lecture :

* https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control
* http://martinfowler.com/bliki/VersionControlTools.html
* http://martinfowler.com/bliki/FeatureBranch.html
* https://about.gitlab.com/2014/09/29/gitlab-flow/
* https://www.atlassian.com/git/tutorials/comparing-workflows
* http://nvie.com/posts/a-successful-git-branching-model/
