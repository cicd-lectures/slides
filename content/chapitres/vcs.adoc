
= Changer du code

== Tracer le changement dans le code

avec un *VCS* : üá¨üáß Version Control System

[.small]
√©galement connu sous le nom de SCM (üá¨üáß Source Code Management)

== Pourquoi un VCS ?

* Pour conserver une trace de *tous* les changements dans un historique

* Pour *collaborer* efficacement sur un m√™me r√©f√©rentiel de code source

[.notes]
--
* Historique : On parle de source unique de v√©rit√© (_Single Source of Truth_)
** Historique complet des modifications
** Possibilit√© de retour arri√®re √† tout moment

* Collaboration:
** Aide √† la r√©solution de conflits
** Partage de contenu facile
--

== Concepts des VCS

image::scm-local.png[caption="Local SCM",width=300]

image::scm-distributed.png[caption="Centralized SCM",width=300]

// https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control

[.notes]
--
* Une base de donn√©e locale contenant l'historique de tous les changements
* Un espace de travail qui contient des fichiers
** C'est une "photographie" d'une des versions
--

== Quel VCS utiliser ?

image::cloudwords-vcs.png[width=500]

Nous allons utiliser *Git*

== Git

[quote]
____
Git is a free and open source distributed version control system designed to handle everything from small to very large projects with speed and efficiency.
____

link:https://git-scm.com/[]

image::git-logo.png[]

== Exercice avec Git - 1

Cr√©er un nouveau d√©p√¥t Git vide localement:

* Cr√©er un dossier vide nomm√© `projet-vcs-1`
* Initialiser le d√©p√¥t git

(Indice : `git init --help` et `git status --help`)

* Cr√©er un fichier `README.md` dedans avec un titre et vos nom et pr√©noms
* Cr√©er un commit qui ajoute le fichier `README.md` avec un message

(Indice : `git add --help` et `git commit --help`)

== Solution de l'exercice avec Git - 1

[source,bash]
--
$ mkdir -p ./projet-vcs-1/
$ cd ./projet-vcs-1/
$ git init ./
$ git status
$ echo "# Read Me\n\nObi Wan" > ./README.md
$ git status
$ git add ./README.md
$ git status
$ git commit -m "Ajoute un README au projet"
$ git status
--

== Terminologie de Git : Basiques

*diff:* un ensemble de lignes "chang√©es" sur un fichier donn√©

image::diff.png[width=500]

*changeset:* un ensemble de "diff" (donc peut couvrir plusieurs fichiers)

image::changeset.png[height=200]

== Terminologie des SCM : Repr√©sentation

*commit:* un changeset qui poss√®de un (commit) parent, associ√© √† un message

image::commit.png[height=150]

_"HEAD"_: C'est le dernier commit dans l'historique

image::scm-basics-legend.png[]

image::scm-basics-history.png[]

== Exercice avec Git - 2

* Afficher la liste des commits

* Afficher le changeset associ√© √† un commit

* Modifier du contenu dans `README.md` et afficher le diff


== Solution de l'exercice avec Git - 2

[source,bash]
--
$ git log
$ git show # Show the "HEAD" commit
$ echo "# Read Me\n\nObi Wan Kenobi" > ./README.md
$ git diff
--

== Terminologie des SCM : Branches

* Abstraction d'une version "isol√©e" du code
* Concr√®tement, une *branche* est un alias pointant vers un "commit"

image::scm-branches.png[caption="SCM branches"]

== Exercice avec Git - 3

* Cr√©er une branche nomm√©e `feature/html`

* Ajouter un nouveau commit contenant un nouveau fichier `index.html` sur cette branche

* Afficher le graphe correspondant √† cette branche avec `git log --graph`

== Solution de l'exercice avec Git - 3

[source,bash]
--
$ git branch feature/html && git checkout feature/html
# Ou git checkout -b feature/html
$ echo '<h1>Hello</h1>' > ./index.html
$ git add ./index.html && git commit -m "Ajout d'une page HTML par d√©faut"
$ git log --graph
# git log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit
--

== Terminologie des SCM : Merge

* On int√®gre une branche dans une autre en effectuant un *merge*
** Un nouveau commit est cr√©√©, fruit de la combinaison de 2 autres commits

image::scm-merge.png[caption="SCM Merge"]

== Exercice avec Git - 4

* Merger la branche `feature/html` dans la branche principale

* Afficher le graphe correspondant √† cette branche avec `git log --graph`

== Solution de l'exercice avec Git - 4

[source,bash]
--
$ git checkout master # or git checkout main
$ git merge `feature/html`
$ git log --graph
# git log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit
--

== Collaboration Flow

image::scm-centralized-flow-how-to.jpg[caption="Centralized SCM Workflow",width=800]

[NOTE.speaker]
====
* Defined by collaborators working from a single code base
** Abstraction of this process is the basis for Trunk based development
* This pattern is the natural usage of a CVCS like SVN or CVS
* It is easy to understand and use, and sufficient enough for a lot of cases
* Collaboration is blocked when centralized server is down or history is broken
====

== Feature Branch Flow

* *Une seule* branche *par* fonctionnalit√©

image::scm-feature-branch-workflow.png[caption="Feature Branch SCM Workflow",link=https://twitter.com/jay_gee/status/702638177471873024]

[NOTE.speaker]
====
** Encapsulation allows working without disturbing the main codebase
** Allows easier collaboration
** Merge conflicts map the conceptual conflicts: easier to track
** Useful when inclusion of a feature in the main code base is open to debate
====

== Exemple d'usages de VCS

* "Infrastructure as Code" :
** Besoins de tra√ßabilit√©, de d√©finition explicite et de gestion de conflits
** Collaboration requise pour chaque changement (revue, responsabilit√©s)
* Code Civil:
** https://github.com/steeve/france.code-civil
** https://github.com/steeve/france.code-civil/pull/40

== Pour aller plus loin avec Git et les VCS...

Un peu de lecture :

* https://git-scm.com/book/en/v2/Getting-Started-About-Version-Control
* http://martinfowler.com/bliki/VersionControlTools.html
* http://martinfowler.com/bliki/FeatureBranch.html
* https://about.gitlab.com/2014/09/29/gitlab-flow/
* https://www.atlassian.com/git/tutorials/comparing-workflows
* http://nvie.com/posts/a-successful-git-branching-model/
